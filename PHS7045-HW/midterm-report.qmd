---
title: "Creating code embedding matrix"
subtitle: "Midterm project for PHS7045"
format: pdf
editor: visual
author: Yidan Zhang
---

## Introduction 

```{r}
library(data.table)

```

```{r}
#| echo: false
data <- fread(file="~/DIAGNOSES_ICD.csv")
```

## Create the co-occurence matrix

want to check how to define which column is icd and which column is the time

```{r}
# Function to create the co-occurrence matrix, allowing dynamic window based on patient data
create_cooccurrence_matrix_dt <- function(data, window = NA) {
  # Ensure the input data is a data.table
  setDT(data)
  
  # Get unique ICD codes
  unique_codes <- unique(data$ICD9_CODE)
  code_count <- length(unique_codes)
  
  # Initialize an empty co-occurrence matrix
  cooccurrence_matrix <- matrix(0, nrow = code_count, ncol = code_count)
  rownames(cooccurrence_matrix) <- unique_codes
  colnames(cooccurrence_matrix) <- unique_codes
  
  # Iterate through each patient
  patients <- unique(data$SUBJECT_ID)
  for (patient in patients) {
    # Get data for the specific patient and sort by SEQ_NUM
    patient_data <- data[SUBJECT_ID == patient][order(SEQ_NUM)]
    
    # If window is NA, set window to be the number of rows for this patient
    if (is.na(window)) {
      patient_window <- nrow(patient_data)
    } else {
      patient_window <- window
    }
    
    # For each ICD code in patient data, compare with others within the window
    for (i in 1:(nrow(patient_data) - 1)) {
      for (j in (i + 1):nrow(patient_data)) {
        if (patient_data$SEQ_NUM[j] - patient_data$SEQ_NUM[i] > patient_window) break
        
        code_i <- patient_data$ICD9_CODE[i]
        code_j <- patient_data$ICD9_CODE[j]
        
        # Update the co-occurrence matrix
        cooccurrence_matrix[code_i, code_j] <- cooccurrence_matrix[code_i, code_j] + 1
        cooccurrence_matrix[code_j, code_i] <- cooccurrence_matrix[code_j, code_i] + 1
      }
    }
  }
  
  return(cooccurrence_matrix)
}


data_try <- data[data$SUBJECT_ID<5,]

cooccurrence_matrix_static <- create_cooccurrence_matrix_dt(data_try, window = 5)

data_try <-  data[data$SUBJECT_ID<5,]

cooccurrence_matrix_dynamic <- create_cooccurrence_matrix_dt(data_try, window = NA)

unique(length(data_try$ICD9_CODE))


```

data set to test the performance
